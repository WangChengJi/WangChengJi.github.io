<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>RabbitMQ | 凉人夢</title><meta name="keywords" content="RabbitMQ"><meta name="author" content="凉人夢"><meta name="copyright" content="凉人夢"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1.MQ简介MQ全称为Message Queue-消息队列，是一种应用程序对应用程序的消息通信，一端只管往队列不断发布信息，另一端只管往队列中读取消息，发布者不需要关心读取消息的谁，读取消息者不需要关心发布消息的是谁，各干各的互不干扰。你可以把它想像成一个邮局，你把信件放入邮箱，邮递员就会把信件投递到你的收件人处。 1.1MQ的工作模型提供者，消费者，MQ队列 1.2MQ作用应用解耦、异步、流量削">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ">
<meta property="og:url" content="https://wangchengji.github.io/fwzssd/b543ced0.html">
<meta property="og:site_name" content="凉人夢">
<meta property="og:description" content="1.MQ简介MQ全称为Message Queue-消息队列，是一种应用程序对应用程序的消息通信，一端只管往队列不断发布信息，另一端只管往队列中读取消息，发布者不需要关心读取消息的谁，读取消息者不需要关心发布消息的是谁，各干各的互不干扰。你可以把它想像成一个邮局，你把信件放入邮箱，邮递员就会把信件投递到你的收件人处。 1.1MQ的工作模型提供者，消费者，MQ队列 1.2MQ作用应用解耦、异步、流量削">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.imgdb.cn/item/6331313216f2c2beb174e10e.jpg">
<meta property="article:published_time" content="2022-09-26T04:51:56.000Z">
<meta property="article:modified_time" content="2022-09-26T14:21:17.398Z">
<meta property="article:author" content="凉人夢">
<meta property="article:tag" content="RabbitMQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/6331313216f2c2beb174e10e.jpg"><link rel="shortcut icon" href="/img/tb2.jpeg"><link rel="canonical" href="https://wangchengji.github.io/fwzssd/b543ced0"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RabbitMQ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-26 22:21:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="凉人夢" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/tx3.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/index.html"><i class="fa-fw fas fa-home"></i><span> 追番</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.imgdb.cn/item/6331313216f2c2beb174e10e.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">凉人夢</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/index.html"><i class="fa-fw fas fa-home"></i><span> 追番</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RabbitMQ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-26T04:51:56.000Z" title="发表于 2022-09-26 12:51:56">2022-09-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-26T14:21:17.398Z" title="更新于 2022-09-26 22:21:17">2022-09-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="RabbitMQ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/fwzssd/b543ced0.html#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/fwzssd/b543ced0.html" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-MQ简介"><a href="#1-MQ简介" class="headerlink" title="1.MQ简介"></a>1.MQ简介</h2><p>MQ全称为Message Queue-消息队列，是一种应用程序对应用程序的消息通信，一端只管往队列不断发布信息，另一端只管往队列中读取消息，发布者不需要关心读取消息的谁，读取消息者不需要关心发布消息的是谁，各干各的互不干扰。你可以把它想像成一个邮局，你把信件放入邮箱，邮递员就会把信件投递到你的收件人处。</p>
<h3 id="1-1MQ的工作模型"><a href="#1-1MQ的工作模型" class="headerlink" title="1.1MQ的工作模型"></a>1.1MQ的工作模型</h3><p>提供者，消费者，MQ队列</p>
<h3 id="1-2MQ作用"><a href="#1-2MQ作用" class="headerlink" title="1.2MQ作用"></a>1.2MQ作用</h3><p>应用解耦、异步、流量削锋、数据分发、错峰流控、日志收集等等…</p>
<ul>
<li><p><strong>解耦：</strong>如果使用feign来实现服务间通信，在服务A中调用了服务B的接口，则服务A和服务B之间就形成了耦合，服务A的运行就依赖于服务B，而如果A服务使用MQ把消息发送给MQ队列，MQ队列再把消息发送给消费者进行消费，A服务就只需要把消息发送给队列即可，即使服务B没有运行，也不影响服务A的运行。</p>
</li>
<li><p><strong>异步：</strong>同样是使用上面这个例子，假设服务A的业务执行时间是50ms，服务B的业务执行时间是100ms，如果是使用feign进行同步调用的话，整个服务A执行完就需要至少150ms，而如果使用MQ进行异步调用的话，服务A就只需要完成自己的业务和发送消息到MQ队列即可，不要等待服务B执行完成，实现了一个异步的调用，提高了接口的执行效率。</p>
</li>
<li><p><strong>流量削锋：</strong>在秒杀这种高并发的场景下，每秒都有可能产生几万甚至十几万条消息，如果没有对消息处理量进行任何限制的话，很有可能因为过多的消息堆积从而导致消费者宕机的情况。因此官网建议对每一个消息消费者都设置处理消息总数（<strong>消息抓取总数</strong>）。</p>
<p>消息抓取总数的值，设置过大或者过小都不好，过小的话，会导致整个系统消息吞吐能力下降，造成性能浪费。过大的话，则很有可能导致消息过多，导致整个系统OOM。因此官网建议每一个消费者将该值设置在100-300之间。</p>
<p>通俗点说就是，如果生产者发送了大量的消息到MQ队列，而如果不做处理的话，消费者会一直接收这庞大的消息，最终把自己压垮，所以可以设置消费者预抓取消息，在自己承受范围之内慢慢的抓取消费消息，同时为了防止消息堆积，可以再新增几个消费者。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//设置预抓取总数</span></span><br><span class="line">channel.basicQos(<span class="number">300</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>日志处理：</strong>日志存储在消息队列中，用来处理日志，比如kafka。</p>
</li>
</ul>
<h2 id="2-RabbitMQ"><a href="#2-RabbitMQ" class="headerlink" title="2.RabbitMQ"></a>2.RabbitMQ</h2><h3 id="2-1简介"><a href="#2-1简介" class="headerlink" title="2.1简介"></a>2.1简介</h3><p>RabbitMQ是一个实现了AMQP（Advanced Message Queuing Protocol）高级消息队列协议的消息队列服务，用Erlang语言。是面向消息的中间件。</p>
<h4 id="2-1-1安装部署"><a href="#2-1-1安装部署" class="headerlink" title="2.1.1安装部署"></a>2.1.1安装部署</h4><p>详情可以参考：<a target="_blank" rel="noopener" href="https://hub.docker.com/_/rabbitmq">https://hub.docker.com/_/rabbitmq</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#在线安装</span><br><span class="line">docker pull rabbitmq:management</span><br><span class="line">#使用官方定义的端口号启动</span><br><span class="line">docker run -d --hostname my-rabbit --name rabbit -p 15672:15672 -p 5672:5672 rabbitmq:management</span><br></pre></td></tr></table></figure>

<h4 id="2-1-2练习小Demo"><a href="#2-1-2练习小Demo" class="headerlink" title="2.1.2练习小Demo"></a>2.1.2练习小Demo</h4><h5 id="2-1-2-1导入依赖"><a href="#2-1-2-1导入依赖" class="headerlink" title="2.1.2.1导入依赖"></a>2.1.2.1导入依赖</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-1-2-2配置文件application-yml"><a href="#2-1-2-2配置文件application-yml" class="headerlink" title="2.1.2.2配置文件application.yml"></a>2.1.2.2配置文件application.yml</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: 106.14.18.189</span><br><span class="line">    port: 5672</span><br><span class="line">    virtual-host: /</span><br><span class="line">    username: xxxx</span><br><span class="line">    password: xxxx</span><br><span class="line">    listener:</span><br></pre></td></tr></table></figure>

<h5 id="2-1-2-2创建生产者和消费者"><a href="#2-1-2-2创建生产者和消费者" class="headerlink" title="2.1.2.2创建生产者和消费者"></a>2.1.2.2创建生产者和消费者</h5><p><strong>消费者：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">// 1.建立连接</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;106.14.18.189&quot;</span>);</span><br><span class="line">    factory.setPort(<span class="number">5672</span>);</span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    factory.setUsername(<span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    factory.setPassword(<span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.2.建立连接</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">// 2.创建通道Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">    <span class="comment">// 3.创建队列</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">    channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 4.订阅消息</span></span><br><span class="line">    channel.basicConsume(queueName, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope,</span></span><br><span class="line"><span class="params">                                   AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">// 5.处理消息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body);</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到消息：【&quot;</span> + message + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(<span class="string">&quot;等待接收消息。。。。&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>生产者：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">    <span class="comment">// 1.建立连接</span></span><br><span class="line">    <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">    <span class="comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span></span><br><span class="line">    factory.setHost(<span class="string">&quot;106.14.18.189&quot;</span>);</span><br><span class="line">    factory.setPort(<span class="number">5672</span>);</span><br><span class="line">    factory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    factory.setUsername(<span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    factory.setPassword(<span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.2.建立连接</span></span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">    <span class="comment">// 2.创建通道Channel</span></span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">    <span class="comment">// 3.创建队列</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">    channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 4.发送消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;小飞棍来喽&quot;</span>;</span><br><span class="line">    channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">    System.out.println(<span class="string">&quot;发送消息成功：【&quot;</span> + message + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    <span class="comment">// 5.关闭通道和连接</span></span><br><span class="line">    channel.close();</span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-1-2-3整合spring注解方式"><a href="#2-1-2-3整合spring注解方式" class="headerlink" title="2.1.2.3整合spring注解方式"></a>2.1.2.3整合spring注解方式</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//声明队列</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Queue <span class="title function_">objectQueue</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;object.queue&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送消息</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testObjectQueue</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 队列名称</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;object.queue&quot;</span>;</span><br><span class="line">       <span class="comment">// 消息</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;小飞棍来喽&quot;</span>;</span><br><span class="line">       <span class="comment">// 发送消息</span></span><br><span class="line">       rabbitTemplate.convertAndSend(queueName, message);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//消费消息</span></span><br><span class="line">   <span class="meta">@RabbitListener(queues = &quot;object.queue&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenWorkQueueMessage1</span><span class="params">(String msg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;接收消息【&quot;</span>+msg+<span class="string">&quot;】&quot;</span>+ LocalDateTime.now());</span><br><span class="line">       Thread.sleep(<span class="number">20</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2RabbitMQ的工作模式"><a href="#2-2RabbitMQ的工作模式" class="headerlink" title="2.2RabbitMQ的工作模式"></a>2.2RabbitMQ的工作模式</h3><h4 id="2-2-1Hello-World简单模型"><a href="#2-2-1Hello-World简单模型" class="headerlink" title="2.2.1Hello World简单模型"></a>2.2.1Hello World简单模型</h4><p>一对一消费，只有一个消费者能接收到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/633162c416f2c2beb1a9e79f.png"></p>
<p>上述demo就是使用的简单描述。</p>
<h4 id="2-2-2Work-queues工作队列"><a href="#2-2-2Work-queues工作队列" class="headerlink" title="2.2.2Work queues工作队列"></a>2.2.2Work queues工作队列</h4><p>多个消费者，你一个我一个分配消费消息，有预取机制，默认公平消费，可配置能者多劳模式，谁完成的快，谁多做一点</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: 106.14.18.189</span><br><span class="line">    port: 5672</span><br><span class="line">    virtual-host: /</span><br><span class="line">    username: xxxx</span><br><span class="line">    password: xxxx</span><br><span class="line">    listener:</span><br><span class="line">      simple:</span><br><span class="line">        prefetch: 1 # 能者多劳，每次只能获取一条，处理完成才能获取下一条</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/633166f316f2c2beb1ae274e.png"></p>
<p>参考练习demo，在其基础上再创建一个或多个消费者即可。</p>
<h4 id="2-2-3Publish-x2F-Subscribe发布订阅模型"><a href="#2-2-3Publish-x2F-Subscribe发布订阅模型" class="headerlink" title="2.2.3Publish&#x2F;Subscribe发布订阅模型"></a>2.2.3Publish&#x2F;Subscribe发布订阅模型</h4><p>发布订阅模式与之前案例的区别就是允许将同一消息发送给多个消费者。<br> 实现方式是加入了exchange(交换机)，注意：交换机是不缓存消息的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/63316a5616f2c2beb1b2089f.png"></p>
<p>声明交换机和队列，并绑定关系</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//声明一个fanout交换机</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//声明一个消息队列1</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue1</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanoutQueue1&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//绑定交换机和队列1</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Binding <span class="title function_">bindingQueue1</span><span class="params">(FanoutExchange fanoutExchange,Queue fanoutQueue1)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> BindingBuilder</span><br><span class="line">               .bind(fanoutQueue1)</span><br><span class="line">               .to(fanoutExchange);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//声明一个消息队列2</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue2</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;fanoutQueue2&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//绑定交换机和队列2</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Binding <span class="title function_">bindingQueue2</span><span class="params">(FanoutExchange fanoutExchange,Queue fanoutQueue2)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> BindingBuilder</span><br><span class="line">               .bind(fanoutQueue2)</span><br><span class="line">               .to(fanoutExchange);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>消费者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanoutQueue1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenFanoutQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;fanoutQueue1收到消息&quot;</span>+msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanoutQueue2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenFanoutQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;fanoutQueue2收到消息&quot;</span>+msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//fanout向交换机发送消息</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanoutQueue</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 交换机名字</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fanoutQueueName</span> <span class="operator">=</span> <span class="string">&quot;fanout&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, everyone&quot;</span>;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(fanoutQueueName,<span class="string">&quot;&quot;</span>,message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-4Routing路由模型"><a href="#2-2-4Routing路由模型" class="headerlink" title="2.2.4Routing路由模型"></a>2.2.4Routing路由模型</h4><p>routing模型也是将消息发送到交换机</p>
<p>使用的是Direct类型的交换机，会将接收到的消息<code>根据规则路由到指定的Queue</code>(队列)，因此称为路由模式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/63316b1a16f2c2beb1b3445d.png"></p>
<p>可以通过@RabbitListener注解，声明消费者的同时创建交换机和队列并绑定关系</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(value = @Queue(name = &quot;directQueue1&quot;)</span></span><br><span class="line"><span class="meta">        ,exchange = @Exchange(name = &quot;direct&quot;,type = ExchangeTypes.DIRECT)</span></span><br><span class="line"><span class="meta">        ,key = &#123;&quot;red&quot;,&quot;blue&quot;&#125;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;directQueue1收到消息&quot;</span>+msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(value = @Queue(name = &quot;directQueue2&quot;)</span></span><br><span class="line"><span class="meta">        ,exchange = @Exchange(name = &quot;direct&quot;,type = ExchangeTypes.DIRECT)</span></span><br><span class="line"><span class="meta">        ,key = &#123;&quot;red&quot;,&quot;yellow&quot;&#125;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDirectQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;directQueue2收到消息&quot;</span>+msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//direct向交换机发送消息</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirectQueue</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 交换机名字</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fanoutQueueName</span> <span class="operator">=</span> <span class="string">&quot;direct&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello, yellow&quot;</span>;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    <span class="comment">//rabbitTemplate.convertAndSend(fanoutQueueName,&quot;blue&quot;,message);</span></span><br><span class="line">    <span class="comment">//rabbitTemplate.convertAndSend(fanoutQueueName,&quot;red&quot;,message);</span></span><br><span class="line">    rabbitTemplate.convertAndSend(fanoutQueueName,<span class="string">&quot;yellow&quot;</span>,message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-5Topics主题模型"><a href="#2-2-5Topics主题模型" class="headerlink" title="2.2.5Topics主题模型"></a>2.2.5Topics主题模型</h4><p>topicExchange与directExchange类型，区别在于routingKey必须是多个单词的列表，并且以 . 分隔</p>
<p>*（代表通配符，任意一个字段）<br>#（号代表一个或多个字段)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/63316d2116f2c2beb1b581cf.png"></p>
<p>消费者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;topicQueue1&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;topic&quot;,type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = &quot;*.orange.*&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;topicQueue1收到消息&quot;</span>+msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(name = &quot;topicQueue2&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(name = &quot;topic&quot;,type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = &quot;lazy.#&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenTopicQueue2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;topicQueue2收到消息&quot;</span>+msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//topic向交换机发送消息</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopicQueue</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 交换机名字</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fanoutQueueName</span> <span class="operator">=</span> <span class="string">&quot;topic&quot;</span>;</span><br><span class="line">    <span class="comment">// 消息</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">message1</span> <span class="operator">=</span> <span class="string">&quot;send to lazy&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">message2</span> <span class="operator">=</span> <span class="string">&quot;send to orange&quot;</span>;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(fanoutQueueName,<span class="string">&quot;lazy.msg&quot;</span>,message1);</span><br><span class="line">    rabbitTemplate.convertAndSend(fanoutQueueName,<span class="string">&quot;send.orange.msg&quot;</span>,message2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-6消息转换器"><a href="#2-2-6消息转换器" class="headerlink" title="2.2.6消息转换器"></a>2.2.6消息转换器</h4><p>代码里直接<code>发送对象</code>，虽然接收的到消息，但是rabbitmq的界面上看到的消息会是乱码，需要消息转换器。</p>
<p><strong>依赖：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageConverter <span class="title function_">jsonMessageConverter</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3延迟消息"><a href="#2-3延迟消息" class="headerlink" title="2.3延迟消息"></a>2.3延迟消息</h3><h4 id="2-3-1基于插件延迟队列"><a href="#2-3-1基于插件延迟队列" class="headerlink" title="2.3.1基于插件延迟队列"></a>2.3.1基于插件延迟队列</h4><p>延迟队列非常常用且好用，可以将<code>消息发送后使消费者延迟接收</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6331705d16f2c2beb1b8b3de.png"></p>
<p><strong><code>RabbitAdmin配置</code></strong></p>
<p>RabbitAdmin是用于对交换机和队列进行管理，用于创建、绑定、删除队列与交换机，发送消息的组件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitAdmin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitAdminConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Value(&quot;$&#123;spring.rabbitmq.host&#125;&quot;)</span></span><br><span class="line">		<span class="keyword">private</span> String host;</span><br><span class="line">		<span class="meta">@Value(&quot;$&#123;spring.rabbitmq.username&#125;&quot;)</span></span><br><span class="line">		<span class="keyword">private</span> String username;</span><br><span class="line">		<span class="meta">@Value(&quot;$&#123;spring.rabbitmq.password&#125;&quot;)</span></span><br><span class="line">		<span class="keyword">private</span> String password;</span><br><span class="line">		<span class="meta">@Value(&quot;$&#123;spring.rabbitmq.virtualhost&#125;&quot;)</span></span><br><span class="line">		<span class="keyword">private</span> String virtualhost;</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="keyword">public</span> ConnectionFactory <span class="title function_">connectionFactory</span><span class="params">()</span>&#123;</span><br><span class="line">			<span class="type">CachingConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CachingConnectionFactory</span>();</span><br><span class="line">			connectionFactory.setAddresses(host);</span><br><span class="line">			connectionFactory.setUsername(username);</span><br><span class="line">			connectionFactory.setPassword(password);</span><br><span class="line">			connectionFactory.setVirtualHost(virtualhost);</span><br><span class="line">			<span class="keyword">return</span> connectionFactory;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="keyword">public</span> RabbitAdmin <span class="title function_">rabbitAdmin</span><span class="params">(ConnectionFactory connectionFactory)</span>&#123;</span><br><span class="line">			<span class="type">RabbitAdmin</span> <span class="variable">rabbitAdmin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RabbitAdmin</span>(connectionFactory);</span><br><span class="line">			rabbitAdmin.setAutoStartup(<span class="literal">true</span>);</span><br><span class="line">			<span class="keyword">return</span> rabbitAdmin;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>封装发送延迟队列工具类</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.CustomExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitAdmin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedQueue</span> &#123;</span><br><span class="line">	<span class="comment">// routingKey</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;delayed.routingkey&quot;</span>;</span><br><span class="line">	<span class="comment">// 延迟队列交换机</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAYED_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;delayed.exchange&quot;</span>;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	RabbitTemplate rabbitTemplate;</span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	RabbitAdmin rabbitAdmin;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 发送延迟队列</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> queueName 队列名称</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> params 消息内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> expiration 延迟时间 毫秒</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayedQueue</span><span class="params">(String queueName, Object params, Integer expiration)</span> &#123;</span><br><span class="line">		<span class="comment">// 先创建一个队列</span></span><br><span class="line">		<span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queueName);</span><br><span class="line">		rabbitAdmin.declareQueue(queue);</span><br><span class="line">		<span class="comment">// 创建延迟队列交换机</span></span><br><span class="line">		<span class="type">CustomExchange</span> <span class="variable">customExchange</span> <span class="operator">=</span> createCustomExchange();</span><br><span class="line">		rabbitAdmin.declareExchange(customExchange);</span><br><span class="line">		<span class="comment">// 将队列和交换机绑定</span></span><br><span class="line">		<span class="type">Binding</span> <span class="variable">binding</span> <span class="operator">=</span> BindingBuilder.bind(queue).to(customExchange).with(DELAYED_ROUTING_KEY).noargs();</span><br><span class="line">		rabbitAdmin.declareBinding(binding);</span><br><span class="line">		<span class="comment">// 发送延迟消息</span></span><br><span class="line">		rabbitTemplate.convertAndSend(DELAYED_EXCHANGE, DELAYED_ROUTING_KEY, params, msg -&gt; &#123;</span><br><span class="line">			<span class="comment">// 发送消息的时候 延迟时长</span></span><br><span class="line">			msg.getMessageProperties().setDelay(expiration);</span><br><span class="line">			<span class="keyword">return</span> msg;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> CustomExchange <span class="title function_">createCustomExchange</span><span class="params">()</span> &#123;</span><br><span class="line">		Map&lt;String, Object&gt; arguments = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 参数说明：</span></span><br><span class="line"><span class="comment">		 * 1.交换机的名称</span></span><br><span class="line"><span class="comment">		 * 2.交换机的类型</span></span><br><span class="line"><span class="comment">		 * 3.是否需要持久化</span></span><br><span class="line"><span class="comment">		 * 4.是否自动删除</span></span><br><span class="line"><span class="comment">		 * 5.其它参数</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		arguments.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(DELAYED_EXCHANGE,<span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, arguments);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>生产者</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DelayedQueue delayedQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送延迟队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queueName 队列名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 消息内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expiration 延迟时间 毫秒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delayedTest8</span><span class="params">()</span> &#123;</span><br><span class="line">	delayedQueue.sendDelayedQueue(<span class="string">&quot;delayTest2&quot;</span>,<span class="string">&quot;这是消息&quot;</span>,<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>消费者</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(value = &quot;delayTest2&quot;,durable = &quot;true&quot;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">declareExchange2</span><span class="params">(String message)</span>&#123;</span><br><span class="line">	System.out.println(<span class="string">&quot;delayTest2 = &quot;</span> + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2TTL队列"><a href="#2-3-2TTL队列" class="headerlink" title="2.3.2TTL队列"></a>2.3.2TTL队列</h4><p>TTL是time to live的缩写，生存时间，RabbitMQ支持消息的过期时间，消息发送时可以指定，从消息入队列开始计算，只要超过队列的<code>超时时间配置，消息没被接收，消息就会自动清除</code></p>
<p><strong><code>封装发送TTL队列工具类</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitAdmin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TtlQueue</span> &#123;</span><br><span class="line">	<span class="comment">// routingKey</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TTL_KEY</span> <span class="operator">=</span> <span class="string">&quot;ttl.routingkey&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TTL_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;ttl.exchange&quot;</span>;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	RabbitTemplate rabbitTemplate;</span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	RabbitAdmin rabbitAdmin;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 发送TTL队列</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> queueName 队列名称</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> params 消息内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> expiration 过期时间 毫秒</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendTtlQueue</span><span class="params">(String queueName, Object params, Integer expiration)</span> &#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * ----------------------------------先创建一个ttl队列--------------------------------------------</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">// 队列设置存活时间，单位ms,必须是整形数据。</span></span><br><span class="line">		map.put(<span class="string">&quot;x-message-ttl&quot;</span>,expiration);</span><br><span class="line">		<span class="comment">/*参数1：队列名称  参数2：持久化  参数3：是否排他 参数4：自动删除队列  参数5：队列参数*/</span></span><br><span class="line">		<span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,map);</span><br><span class="line">		rabbitAdmin.declareQueue(queue);</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * ---------------------------------创建交换机---------------------------------------------</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="type">DirectExchange</span> <span class="variable">directExchange</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(TTL_EXCHANGE, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">		rabbitAdmin.declareExchange(directExchange);</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * ---------------------------------队列绑定交换机---------------------------------------------</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">// 将队列和交换机绑定</span></span><br><span class="line">		<span class="type">Binding</span> <span class="variable">binding</span> <span class="operator">=</span> BindingBuilder.bind(queue).to(directExchange).with(TTL_KEY);</span><br><span class="line">		rabbitAdmin.declareBinding(binding);</span><br><span class="line">		<span class="comment">// 发送消息</span></span><br><span class="line">		rabbitTemplate.convertAndSend(TTL_EXCHANGE,TTL_KEY,params);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>生产者</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TtlQueue ttlQueue;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送TTL队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queueName 队列名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 消息内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expiration 过期时间 毫秒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ttlQueueTest10</span><span class="params">()</span> &#123;</span><br><span class="line">	ttlQueue.sendTtlQueue(<span class="string">&quot;ttlQueue&quot;</span>,<span class="string">&quot;这是消息内容&quot;</span>,<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>消费者</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;ttlQueue&quot; )</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ttlQueue</span><span class="params">(String message)</span>&#123;</span><br><span class="line">	System.out.println(<span class="string">&quot;message = &quot;</span> + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3死信队列"><a href="#2-3-3死信队列" class="headerlink" title="2.3.3死信队列"></a>2.3.3死信队列</h4><p>DLX，全称为Dead-Letter-Exchange，可以称之为死信交换器。队列消息变成死信(deadmessage)之后，它能被重新被发送到另一个交换器中，这个交换器就是DLX，绑定DLX的队列就称之为死信队列。<br>消息变成死信的几种情况：</p>
<p>   1.消息被拒绝（basic.reject&#x2F; basic.nack）并且requeue&#x3D;false<br>2. 消息TTL过期<br>3. 队列达到最大长度</p>
<p>流程：发送消息，消息过期后进入到另一个队列（这个队列设置持久化，不过期）的过程。<br><strong><code>封装发送死信队列工具类</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitAdmin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DLXQueue</span> &#123;</span><br><span class="line">	<span class="comment">// routingKey</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;dead.routingkey&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;routingkey&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEAD_EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;dead.exchange&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE</span> <span class="operator">=</span> <span class="string">&quot;common.exchange&quot;</span>;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	RabbitTemplate rabbitTemplate;</span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	RabbitAdmin rabbitAdmin;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 发送死信队列，过期后进入死信交换机，进入死信队列</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> queueName 队列名称</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> deadQueueName 死信队列名称</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> params 消息内容</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> expiration 过期时间 毫秒</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDLXQueue</span><span class="params">(String queueName, String deadQueueName,Object params, Integer expiration)</span>&#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * ----------------------------------先创建一个ttl队列和死信队列--------------------------------------------</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">// 队列设置存活时间，单位ms,必须是整形数据。</span></span><br><span class="line">		map.put(<span class="string">&quot;x-message-ttl&quot;</span>,expiration);</span><br><span class="line">		<span class="comment">// 设置死信交换机</span></span><br><span class="line">		map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,DEAD_EXCHANGE);</span><br><span class="line">		<span class="comment">// 设置死信交换器路由键</span></span><br><span class="line">		map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_ROUTING_KEY);</span><br><span class="line">		<span class="comment">/*参数1：队列名称  参数2：持久化  参数3：是否排他 参数4：自动删除队列  参数5：队列参数*/</span></span><br><span class="line">		<span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,map);</span><br><span class="line">		rabbitAdmin.declareQueue(queue);</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * ---------------------------------创建交换机---------------------------------------------</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="type">DirectExchange</span> <span class="variable">directExchange</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(EXCHANGE, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">		rabbitAdmin.declareExchange(directExchange);</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * ---------------------------------队列绑定交换机---------------------------------------------</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="type">Binding</span> <span class="variable">binding</span> <span class="operator">=</span> BindingBuilder.bind(queue).to(directExchange).with(ROUTING_KEY);</span><br><span class="line">		rabbitAdmin.declareBinding(binding);</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * ---------------------------------在创建一个死信交换机和队列，接收死信队列---------------------------------------------</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="type">DirectExchange</span> <span class="variable">deadExchange</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(DEAD_EXCHANGE, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">		rabbitAdmin.declareExchange(deadExchange);</span><br><span class="line"></span><br><span class="line">		<span class="type">Queue</span> <span class="variable">deadQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(deadQueueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">		rabbitAdmin.declareQueue(deadQueue);</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * ---------------------------------队列绑定死信交换机---------------------------------------------</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">// 将队列和交换机绑定</span></span><br><span class="line">		<span class="type">Binding</span> <span class="variable">deadbinding</span> <span class="operator">=</span> BindingBuilder.bind(deadQueue).to(deadExchange).with(DEAD_ROUTING_KEY);</span><br><span class="line">		rabbitAdmin.declareBinding(deadbinding);</span><br><span class="line">		<span class="comment">// 发送消息</span></span><br><span class="line">		rabbitTemplate.convertAndSend(EXCHANGE,ROUTING_KEY,params);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>生产者</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DLXQueue dlxQueue;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送死信队列，过期后进入死信交换机，进入死信队列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queueName 队列名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> deadQueueName 死信队列名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 消息内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expiration 过期时间 毫秒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dlxQueueTest11</span><span class="params">()</span> &#123;</span><br><span class="line">	dlxQueue.sendDLXQueue(<span class="string">&quot;queue&quot;</span>,<span class="string">&quot;deadQueue&quot;</span>,<span class="string">&quot;这是消息内容&quot;</span>,<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>消费者</code></strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 接收转移后的队列消息</span></span><br><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(value = &quot;deadQueue&quot;,durable = &quot;true&quot;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ttlQueue</span><span class="params">(String message)</span>&#123;</span><br><span class="line">	System.out.println(<span class="string">&quot;message = &quot;</span> + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4常用的其他MQ"><a href="#2-4常用的其他MQ" class="headerlink" title="2.4常用的其他MQ"></a>2.4常用的其他MQ</h3><table>
<thead>
<tr>
<th></th>
<th align="center">RabbitMQ</th>
<th align="center">ActiveMQ</th>
<th align="center">RocketMQ</th>
<th align="center">Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>公司&#x2F;社区</td>
<td align="center">Rabbit</td>
<td align="center">Apache</td>
<td align="center">阿里</td>
<td align="center">Apache</td>
</tr>
<tr>
<td>开发语言</td>
<td align="center">Erlang</td>
<td align="center">Java</td>
<td align="center">Java</td>
<td align="center">Scala&amp;Java</td>
</tr>
<tr>
<td>协议支持</td>
<td align="center">AMQP,XMPP,SMTP,STOMP</td>
<td align="center">OpenWire，STOMP，REST，XMPP,AMQP</td>
<td align="center">自定义</td>
<td align="center">自定义</td>
</tr>
<tr>
<td>可用性</td>
<td align="center">高</td>
<td align="center">一般</td>
<td align="center">高</td>
<td align="center">高</td>
</tr>
<tr>
<td>单机吞吐量</td>
<td align="center">一般</td>
<td align="center">差</td>
<td align="center">高</td>
<td align="center">非常高</td>
</tr>
<tr>
<td>消息延迟</td>
<td align="center">微妙级</td>
<td align="center">毫秒级</td>
<td align="center">毫秒级</td>
<td align="center">毫秒以内</td>
</tr>
<tr>
<td>消息可靠性</td>
<td align="center">高</td>
<td align="center">一般</td>
<td align="center">高</td>
<td align="center">一般</td>
</tr>
</tbody></table>
<h3 id="2-5常见问题"><a href="#2-5常见问题" class="headerlink" title="2.5常见问题"></a>2.5常见问题</h3><h4 id="2-5-1消息丢失问题"><a href="#2-5-1消息丢失问题" class="headerlink" title="2.5.1消息丢失问题"></a>2.5.1消息丢失问题</h4><p>按照现有rabbitMQ的相关知识，生产者会发送消息到达消息服务器。但是在实际生产环境下，消息生产者发送的消息很有可能当到达了消息服务器之后，由于消息服务器的问题导致消息丢失，如宕机。因为消息服务器默认会将消息存储在内存中。一旦消息服务器宕机，则消息会产生丢失。因此要保证生产者的消息不丢失，要开始持久化策略。</p>
<p><strong>rabbitMQ持久化：</strong><br>    交换机持久化<br>    队列持久化<br>    消息持久化</p>
<p>但是如果仅仅只是开启这两部分的持久化，也很有可能造成消息丢失。因为消息服务器很有可能在持久化的过程中出现宕机。因此需要通过数据保护机制来保证消息一定会成功进行持久化，否则将一直进行消息发送。</p>
<p><strong>RabbitMQ数据保护机制</strong><br>  <strong>事务机制</strong><br>    事务机制采用类数据库的事务机制进行数据保护，当消息到达消息服务器，首先会开启一个事务，接着进行数据磁盘持久化，只有持久化成功才会进行事务提交，向消息生产者返回成功通知，消息生产者一旦接收成功通知则不会再发送此条消息。当出现异常，则返回失败通知.消息生产者一旦接收失败通知，则继续发送该条消息。<br>    事务机制虽然能够保证数据安全，但是此机制采用的是同步机制，会产生系统间消息阻塞，影响整个系统的消息吞吐量。从而导致整个系统的性能下降，因此不建议使用。<br>  <strong>confirm机制</strong><br>    confirm模式需要基于channel进行设置, 一旦某条消息被投递到队列之后,消息队列就会发送一个确认信息给生产者,如果队列与消息是可持久化的, 那么确认消息会等到消息成功写入到磁盘之后发出。<br>    confirm的性能高,主要得益于它是异步的.生产者在将第一条消息发出之后等待确认消息的同时也可以继续发送后续的消息.当确认消息到达之后,就可以通过回调方法处理这条确认消息. 如果MQ服务宕机了,则会返回nack消息. 生产者同样在回调方法中进行后续处理。</p>
<h4 id="2-5-2如何保证消息的有序性"><a href="#2-5-2如何保证消息的有序性" class="headerlink" title="2.5.2如何保证消息的有序性"></a>2.5.2如何保证消息的有序性</h4><p>1.保证只有一个消费者        </p>
<p>2.给消息添加一个消费的顺序编号，通过编号来确定谁先消费。</p>
<h4 id="2-5-3MQ如何防止重复消息（消息的幂等）"><a href="#2-5-3MQ如何防止重复消息（消息的幂等）" class="headerlink" title="2.5.3MQ如何防止重复消息（消息的幂等）"></a>2.5.3MQ如何防止重复消息（消息的幂等）</h4><p>使用redis，在生产者发送消息时在redis中生成一个key（建议是zset，设置大小为1），把这个key放到消息中传递给消费者，消费者在消费消息前先判断该消息的值是否已经被消费过，即判断传入的key是否存在和zset的大小是否是1，如果不存在该key或者值的大小不为1，则代表该消息已执行抛弃这条消息，不然则对zset的值进行increment，在执行完业务后，再把这个key删除，这样就防止了消息的重复消费。（并不是所有的业务都要做幂等判断，要根据业务来设计）</p>
<h4 id="2-5-4如何防止请求的洪灾（削锋）"><a href="#2-5-4如何防止请求的洪灾（削锋）" class="headerlink" title="2.5.4如何防止请求的洪灾（削锋）"></a>2.5.4如何防止请求的洪灾（削锋）</h4><p> 设置MQ的预抓取总数（channel.basicQos(200); &#x2F;&#x2F;代表每次预抓取200条消息），把MQ主动推送消息变成消费方手主动抓取消息。</p>
<h4 id="2-5-5如何解决MQ的消息堆积"><a href="#2-5-5如何解决MQ的消息堆积" class="headerlink" title="2.5.5如何解决MQ的消息堆积"></a>2.5.5如何解决MQ的消息堆积</h4><p>1.增加消费者。    2.多线程消费（使用线程池，异步处理消费的消息业务，即加快消费者的效率）</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://wangchengji.github.io">凉人夢</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wangchengji.github.io/fwzssd/b543ced0.html">https://wangchengji.github.io/fwzssd/b543ced0.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wangchengji.github.io" target="_blank">凉人夢</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RabbitMQ/">RabbitMQ</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imgdb.cn/item/6331313216f2c2beb174e10e.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wx.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/wx.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/zfb.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/zfb.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/fwzssd/d111bf74.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/633120a116f2c2beb1659520.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JDK1.8新特性</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/tx3.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">凉人夢</div><div class="author-info__description">我宁愿犯错也不愿意什么也不做</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/WangChengJi"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-MQ%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">1.MQ简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1MQ%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1.1MQ的工作模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2MQ%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">1.2MQ作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-RabbitMQ"><span class="toc-number">2.</span> <span class="toc-text">2.RabbitMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1安装部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2%E7%BB%83%E4%B9%A0%E5%B0%8FDemo"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2练习小Demo</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-1%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">2.1.2.1导入依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-2%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6application-yml"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">2.1.2.2配置文件application.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-2%E5%88%9B%E5%BB%BA%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">2.1.2.2创建生产者和消费者</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-3%E6%95%B4%E5%90%88spring%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F"><span class="toc-number">2.1.2.4.</span> <span class="toc-text">2.1.2.3整合spring注解方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2RabbitMQ%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2.2RabbitMQ的工作模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1Hello-World%E7%AE%80%E5%8D%95%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.2.1Hello World简单模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2Work-queues%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2.2Work queues工作队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3Publish-x2F-Subscribe%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.2.3Publish&#x2F;Subscribe发布订阅模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4Routing%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.2.4Routing路由模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-5Topics%E4%B8%BB%E9%A2%98%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.2.5Topics主题模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-6%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">2.2.6.</span> <span class="toc-text">2.2.6消息转换器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">2.3.</span> <span class="toc-text">2.3延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1%E5%9F%BA%E4%BA%8E%E6%8F%92%E4%BB%B6%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1基于插件延迟队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2TTL%E9%98%9F%E5%88%97"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2TTL队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3死信队列</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E5%B8%B8%E7%94%A8%E7%9A%84%E5%85%B6%E4%BB%96MQ"><span class="toc-number">2.4.</span> <span class="toc-text">2.4常用的其他MQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">2.5.</span> <span class="toc-text">2.5常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98"><span class="toc-number">2.5.1.</span> <span class="toc-text">2.5.1消息丢失问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.5.2如何保证消息的有序性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-3MQ%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E6%B6%88%E6%81%AF%EF%BC%88%E6%B6%88%E6%81%AF%E7%9A%84%E5%B9%82%E7%AD%89%EF%BC%89"><span class="toc-number">2.5.3.</span> <span class="toc-text">2.5.3MQ如何防止重复消息（消息的幂等）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-4%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E8%AF%B7%E6%B1%82%E7%9A%84%E6%B4%AA%E7%81%BE%EF%BC%88%E5%89%8A%E9%94%8B%EF%BC%89"><span class="toc-number">2.5.4.</span> <span class="toc-text">2.5.4如何防止请求的洪灾（削锋）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-5%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3MQ%E7%9A%84%E6%B6%88%E6%81%AF%E5%A0%86%E7%A7%AF"><span class="toc-number">2.5.5.</span> <span class="toc-text">2.5.5如何解决MQ的消息堆积</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/fwzssd/b543ced0.html" title="RabbitMQ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/6331313216f2c2beb174e10e.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RabbitMQ"/></a><div class="content"><a class="title" href="/fwzssd/b543ced0.html" title="RabbitMQ">RabbitMQ</a><time datetime="2022-09-26T04:51:56.000Z" title="发表于 2022-09-26 12:51:56">2022-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/fwzssd/d111bf74.html" title="JDK1.8新特性"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/633120a116f2c2beb1659520.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JDK1.8新特性"/></a><div class="content"><a class="title" href="/fwzssd/d111bf74.html" title="JDK1.8新特性">JDK1.8新特性</a><time datetime="2022-09-25T04:23:51.000Z" title="发表于 2022-09-25 12:23:51">2022-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/fwzssd/undefined.html" title="EasyExcel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/63241a3e16f2c2beb104ad35.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EasyExcel"/></a><div class="content"><a class="title" href="/fwzssd/undefined.html" title="EasyExcel">EasyExcel</a><time datetime="2022-09-22T12:47:16.000Z" title="发表于 2022-09-22 20:47:16">2022-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/fwzssd/e5adb42e.html" title="Redis的持久化机制"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/631f2ac916f2c2beb1887f30.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis的持久化机制"/></a><div class="content"><a class="title" href="/fwzssd/e5adb42e.html" title="Redis的持久化机制">Redis的持久化机制</a><time datetime="2022-09-12T03:31:11.000Z" title="发表于 2022-09-12 11:31:11">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/fwzssd/197f8.html" title="Redis的过期键删除策略"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://images7.alphacoders.com/121/1210460.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis的过期键删除策略"/></a><div class="content"><a class="title" href="/fwzssd/197f8.html" title="Redis的过期键删除策略">Redis的过期键删除策略</a><time datetime="2022-09-09T07:25:35.000Z" title="发表于 2022-09-09 15:25:35">2022-09-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 凉人夢</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'EMDp1c6otATIp4fWBJexOy9J-gzGzoHsz',
      appKey: 'gqXRqOlakscVkhFT7kmnCmFQ',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="8608277355" data-server="tencent" data-type="playlist"   data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true" ></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>